name: Production Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  production-test:
    name: Production Tests
    runs-on: macos-15
    # Only run when secrets are available (not from fork PRs)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    env:
      TEST_ACCOUNT_EMAIL: ${{ secrets.TEST_ACCOUNT_EMAIL }}
      TEST_ACCOUNT_PASSWORD: ${{ secrets.TEST_ACCOUNT_PASSWORD }}
      TEST_DEVICE_GUID: ${{ secrets.TEST_DEVICE_GUID }}
      TEST_ACCOUNT_DATA: ${{ secrets.TEST_ACCOUNT_DATA }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore account cache
        uses: actions/cache@v4
        with:
          path: ~/.ipatool/
          key: ipatool-account-${{ github.sha }}
          restore-keys: |
            ipatool-account-

      - name: Run production tests
        run: |
          set -o pipefail
          xcodebuild test -scheme ApplePackage \
            -destination "platform=macOS" \
            -only-testing:ApplePackageTests/ApplePackageAuthenticateTests \
            -only-testing:ApplePackageTests/ApplePackageDownloadTests \
            -only-testing:ApplePackageTests/ApplePackageVersionFinderTests \
            -only-testing:ApplePackageTests/ApplePackageVersionLookupTests \
            2>&1 | sed "s/${TEST_ACCOUNT_PASSWORD:-__PLACEHOLDER__}/[REDACTED]/g" | xcbeautify
